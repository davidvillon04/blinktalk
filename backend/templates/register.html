{% extends "base.html" %}

{% block content %}
<div style="
  max-width: 400px; 
  margin: 4rem auto; 
  background: rgba(0, 0, 0, 0.6); 
  padding: 2rem; 
  border-radius: 8px;
">
  <h2 style="margin-bottom: 0.5rem;">Create an account</h2>

  <!-- Display flash messages (if any) -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
          <p>{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Registration Form -->
  <!-- Note: Using 'type="text"' for email to avoid default HTML5 popups. We'll do custom validation. -->
  <form method="POST" style="display: flex; flex-direction: column; gap: 1rem;" novalidate>
    <!-- Email -->
    <div>
      <label for="email" style="display: block; margin-bottom: 0.3rem;">
        EMAIL <span style="color: #ffaaaa;">*</span>
      </label>
      <input 
        type="text" 
        id="email" 
        name="email" 
        placeholder="Email"
        style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;"
        required
      >
      <!-- Custom email error message -->
      <div 
        id="emailError" 
        style="font-size: 0.9em; margin-top: 4px; color: #ffaaaa; display: none;"
      ></div>
    </div>

    <!-- Username -->
    <div>
      <label for="username" style="display: block; margin-bottom: 0.3rem;">
        USERNAME <span style="color: #ffaaaa;">*</span>
      </label>
      <input 
        type="text" 
        id="username" 
        name="username" 
        placeholder="Username"
        style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;"
        required
      >
      <!-- Username Hint (hidden until focus) -->
      <div 
        id="usernameHint" 
        style="font-size: 0.9em; margin-top: 4px; color: #ffaaaa; display: none;"
      >
        Username must be 2-32 characters long and can only contain letters, 
        numbers, underscores (_) and periods (.).
      </div>
    </div>

    <!-- Password -->
    <div>
      <label for="password" style="display: block; margin-bottom: 0.3rem;">
        PASSWORD <span style="color: #ffaaaa;">*</span>
      </label>
      <!-- Inline-flex container for password input + toggle button -->
      <div style="display: inline-flex; align-items: center; position: relative; width: 100%;">
        <input 
          type="password" 
          id="password" 
          name="password" 
          placeholder="Password"
          style="
            flex: 1;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            padding-right: 3rem; /* space for the toggle button */
          "
          required
        >
        <button
          type="button"
          onclick="togglePassword('password', this)"
          style="
            position: absolute;
            right: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #000000;
          "
        >
          Show
        </button>
      </div>

      <!-- Password Strength Meter (hidden until focus) -->
      <div id="passwordStrengthContainer" style="margin-top: 5px; display: none;">
        <meter max="100" id="passwordMeter" value="0" style="width: 100%;"></meter>
        <div id="passwordStrengthText" style="font-size: 0.9em; margin-top: 3px;"></div>
      </div>
    </div>

    <!-- Confirm Password -->
    <div>
      <label for="confirm" style="display: block; margin-bottom: 0.3rem;">
        CONFIRM PASSWORD <span style="color: #ffaaaa;">*</span>
      </label>
      <!-- Inline-flex container for confirm password + toggle button -->
      <div style="display: inline-flex; align-items: center; position: relative; width: 100%;">
        <input 
          type="password" 
          id="confirm" 
          name="confirm" 
          placeholder="Confirm Password"
          style="
            flex: 1;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            padding-right: 3rem; /* space for the toggle button */
          "
          required
        >
        <button
          type="button"
          onclick="togglePassword('confirm', this)"
          style="
            position: absolute;
            right: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #000000;
          "
        >
          Show
        </button>
      </div>
      <!-- Mismatch error message -->
      <div 
        id="confirmError" 
        style="font-size: 0.9em; margin-top: 4px; color: #ffaaaa; display: none;"
      ></div>
    </div>

    <!-- Date of Birth -->
    <div>
      <label style="display: block; margin-bottom: 0.3rem;">
        DATE OF BIRTH <span style="color: #ffaaaa;">*</span>
      </label>
      <div style="display: flex; gap: 0.5rem;">
        <!-- Month -->
        <select 
          id="month" 
          name="month" 
          style="flex: 1; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;"
          required
        >
          <option value="" disabled selected>Month</option>
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5">May</option>
          <option value="6">June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>

        <!-- Day -->
        <select 
          id="day" 
          name="day" 
          style="flex: 1; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;"
          required
        >
          <option value="" disabled selected>Day</option>
        </select>

        <!-- Year -->
        <select 
          id="year" 
          name="year" 
          style="flex: 1; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;"
          required
        >
          <option value="" disabled selected>Year</option>
        </select>
      </div>
    </div>

    <!-- Continue Button -->
    <input 
      type="submit" 
      value="Continue"
      style="
        background-color: #0a3a54; 
        color: #ffffff; 
        border: none; 
        padding: 0.7rem; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 1rem;
      "
    >
  </form>

  <!-- Terms & Privacy Note -->
  <p style="margin-top: 1rem; font-size: 0.85rem;">
    By registering, you agree to BlinkTalk's 
    <a href="#" style="color: #cceeff; text-decoration: underline;">Terms of Service</a> 
    and 
    <a href="#" style="color: #cceeff; text-decoration: underline;">Privacy Policy</a>.
  </p>

  <!-- Already have an account? -->
  <p style="margin-top: 1rem; font-size: 0.9rem;">
    Already have an account?
    <a href="{{ url_for('login') }}" style="color: #cceeff; text-decoration: underline;">Login</a>
  </p>
</div>

<script>
// ================
// Show/Hide Toggles
// ================
function togglePassword(inputId, btn) {
  const inputField = document.getElementById(inputId);
  if (inputField.type === "password") {
    inputField.type = "text";
    btn.textContent = "Hide";
  } else {
    inputField.type = "password";
    btn.textContent = "Show";
  }
}

// 1. Custom Email Validation
const emailInput = document.getElementById('email');
const emailError = document.getElementById('emailError');

emailInput.addEventListener('input', function() {
  const emailVal = emailInput.value.trim();
  // Basic check: must contain "@" and "."
  if (emailVal !== "" && (!emailVal.includes('@') || !emailVal.includes('.'))) {
    emailError.style.display = 'block';
    emailError.textContent = "Please enter a valid email (e.g., user@example.com).";
  } else {
    emailError.style.display = 'none';
  }
});

// 2. Username Live Validation Hint
const usernameInput = document.getElementById('username');
const usernameHint = document.getElementById('usernameHint');

usernameInput.addEventListener('focus', function() {
  usernameHint.style.display = 'block';
});

usernameInput.addEventListener('input', function() {
  const username = usernameInput.value;
  const regex = /^[A-Za-z0-9_.]{2,32}$/;
  if (regex.test(username)) {
    usernameHint.style.color = '#aaffaa'; // Valid: green-ish
  } else {
    usernameHint.style.color = '#ffaaaa'; // Invalid: red-ish
  }
});

// 3. Password Strength Meter
const passwordInput = document.getElementById('password');
const passwordMeter = document.getElementById('passwordMeter');
const passwordStrengthText = document.getElementById('passwordStrengthText');
const passwordStrengthContainer = document.getElementById('passwordStrengthContainer');

passwordInput.addEventListener('focus', function() {
  passwordStrengthContainer.style.display = 'block';
});

passwordInput.addEventListener('input', function() {
  const pwd = passwordInput.value;
  let strength = 0;

  if (pwd.length >= 6)  strength += 20;
  if (pwd.length >= 10) strength += 20;
  if (/[A-Z]/.test(pwd)) strength += 20;
  if (/[0-9]/.test(pwd)) strength += 20;
  if (/[\W_]/.test(pwd)) strength += 20;

  passwordMeter.value = strength;

  let color;
  if (strength < 40) {
    passwordStrengthText.textContent = "Weak";
    passwordStrengthText.style.color = "#ff4444";
    color = "#ff4444";
  } else if (strength < 80) {
    passwordStrengthText.textContent = "Moderate";
    passwordStrengthText.style.color = "#ffbb33";
    color = "#ffbb33";
  } else {
    passwordStrengthText.textContent = "Strong";
    passwordStrengthText.style.color = "#00C851";
    color = "#00C851";
  }
  passwordMeter.style.setProperty('--strength-color', color);
});

// 4. Real-time Confirm Password Mismatch
const confirmInput = document.getElementById('confirm');
const confirmError = document.getElementById('confirmError');

function checkPasswordsMatch() {
  if (confirmInput.value && passwordInput.value !== confirmInput.value) {
    confirmError.style.display = 'block';
    confirmError.textContent = "Passwords do not match.";
  } else {
    confirmError.style.display = 'none';
  }
}
confirmInput.addEventListener('input', checkPasswordsMatch);
passwordInput.addEventListener('input', checkPasswordsMatch);

// 5. Dynamic Days in the Month
const monthSelect = document.getElementById('month');
const daySelect = document.getElementById('day');
const yearSelect = document.getElementById('year');

// Populate the year dropdown from current year down to currentYear - 150
const currentYear = new Date().getFullYear();
for (let y = currentYear; y >= currentYear - 150; y--) {
  const option = document.createElement('option');
  option.value = y;
  option.textContent = y;
  yearSelect.appendChild(option);
}

// Helper: Check if leap year
function isLeapYear(y) {
  return ((y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0));
}

// Helper: Days in month
function getDaysInMonth(m, y) {
  if (!m || !y) return 31;
  if (m === 2) {
    return isLeapYear(y) ? 29 : 28;
  } else if ([4, 6, 9, 11].includes(m)) {
    return 30;
  } else {
    return 31;
  }
}

// Update days whenever month or year changes
function updateDays() {
  const m = parseInt(monthSelect.value);
  const y = parseInt(yearSelect.value);
  daySelect.innerHTML = '<option value="" disabled selected>Day</option>';
  const totalDays = getDaysInMonth(m, y);
  for (let d = 1; d <= totalDays; d++) {
    const option = document.createElement('option');
    option.value = d;
    option.textContent = d;
    daySelect.appendChild(option);
  }
}

monthSelect.addEventListener('change', updateDays);
yearSelect.addEventListener('change', updateDays);
</script>
{% endblock %}
