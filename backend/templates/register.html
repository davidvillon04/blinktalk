{% extends "base.html" %}

{% block content %}
<div style="
  max-width: 400px; 
  margin: 4rem auto; 
  background: rgba(0, 0, 0, 0.6); 
  padding: 2rem; 
  border-radius: 8px;
">
  <h2 style="margin-bottom: 0.5rem;">Create an account</h2>

  <!-- Display flash messages -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
          <p>{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Registration Form -->
  <form method="POST" id="registerForm" style="display: flex; flex-direction: column; gap: 1rem;" novalidate>
    <!-- Email -->
    <div>
      <label for="email" style="display: block; margin-bottom: 0.3rem;">
        EMAIL <span style="color: #ffaaaa;">*</span>
      </label>
      <input 
        type="text" 
        id="email" 
        name="email" 
        placeholder="Email"
        value="{{ form_data.get('email', '') }}"
        style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;"
        required
      >
      <div id="emailError" style="font-size: 0.9em; margin-top: 4px; color: #ffaaaa; display: none;"></div>
    </div>

    <!-- Username -->
    <div>
      <label for="username" style="display: block; margin-bottom: 0.3rem;">
        USERNAME <span style="color: #ffaaaa;">*</span>
      </label>
      <input 
        type="text" 
        id="username" 
        name="username" 
        placeholder="Username"
        value="{{ form_data.get('username', '') }}"
        style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;"
        required
      >
      <div id="usernameHint" style="font-size: 0.9em; margin-top: 4px; color: #ffaaaa; display: none;">
        Username must be 2-32 characters long and can only contain letters, numbers, underscores (_) and periods (.).
      </div>
      <div id="usernameExists" style="font-size: 0.9em; margin-top: 4px; color: #ff4444; display: none;">
        This username is already taken.
      </div>
    </div>

    <!-- Password -->
    <div>
      <label for="password" style="display: block; margin-bottom: 0.3rem;">
        PASSWORD <span style="color: #ffaaaa;">*</span>
      </label>
      <div style="display: inline-flex; align-items: center; position: relative; width: 100%;">
        <input 
          type="password" 
          id="password" 
          name="password" 
          placeholder="Password"
          style="
            flex: 1;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            padding-right: 3rem;
          "
          required
        >
        <button
          type="button"
          onclick="togglePassword('password', this)"
          style="
            position: absolute;
            right: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #000000;
          "
        >
          Show
        </button>
      </div>
      <div id="passwordStrengthContainer" style="margin-top: 5px; display: none;">
        <meter max="100" id="passwordMeter" value="0" style="width: 100%;"></meter>
        <div id="passwordStrengthText" style="font-size: 0.9em; margin-top: 3px;"></div>
      </div>
    </div>

    <!-- Confirm Password -->
    <div>
      <label for="confirm" style="display: block; margin-bottom: 0.3rem;">
        CONFIRM PASSWORD <span style="color: #ffaaaa;">*</span>
      </label>
      <div style="display: inline-flex; align-items: center; position: relative; width: 100%;">
        <input 
          type="password" 
          id="confirm" 
          name="confirm" 
          placeholder="Confirm Password"
          style="
            flex: 1;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
            padding-right: 3rem;
          "
          required
        >
        <button
          type="button"
          onclick="togglePassword('confirm', this)"
          style="
            position: absolute;
            right: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #000000;
          "
        >
          Show
        </button>
      </div>
      <div id="confirmError" style="font-size: 0.9em; margin-top: 4px; color: #ff4444; display: none;"></div>
    </div>

    <!-- Date of Birth -->
    <div>
      <label style="display: block; margin-bottom: 0.3rem;">
        DATE OF BIRTH <span style="color: #ffaaaa;">*</span>
      </label>
      <div style="display: flex; gap: 0.5rem;">
        <select id="month" name="month" required style="flex: 1; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
          <option value="" disabled selected>Month</option>
          <option value="1" {% if form_data.get('month') == "1" %}selected{% endif %}>January</option>
          <option value="2" {% if form_data.get('month') == "2" %}selected{% endif %}>February</option>
          <option value="3" {% if form_data.get('month') == "3" %}selected{% endif %}>March</option>
          <option value="4" {% if form_data.get('month') == "4" %}selected{% endif %}>April</option>
          <option value="5" {% if form_data.get('month') == "5" %}selected{% endif %}>May</option>
          <option value="6" {% if form_data.get('month') == "6" %}selected{% endif %}>June</option>
          <option value="7" {% if form_data.get('month') == "7" %}selected{% endif %}>July</option>
          <option value="8" {% if form_data.get('month') == "8" %}selected{% endif %}>August</option>
          <option value="9" {% if form_data.get('month') == "9" %}selected{% endif %}>September</option>
          <option value="10" {% if form_data.get('month') == "10" %}selected{% endif %}>October</option>
          <option value="11" {% if form_data.get('month') == "11" %}selected{% endif %}>November</option>
          <option value="12" {% if form_data.get('month') == "12" %}selected{% endif %}>December</option>
        </select>

        <select id="day" name="day" required style="flex: 1; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
          <option value="" disabled selected>Day</option>
          <!-- The day options will be updated by JavaScript; optionally pre-select if form_data exists -->
        </select>

        <select id="year" name="year" required style="flex: 1; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc;">
          <option value="" disabled selected>Year</option>
          <!-- The year options are populated by JavaScript -->
        </select>
      </div>
    </div>

    <!-- Continue Button -->
    <input 
      type="submit" 
      value="Continue"
      style="
        background-color: #0a3a54; 
        color: #ffffff; 
        border: none; 
        padding: 0.7rem; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 1rem;
      "
    >
  </form>

  <!-- Terms & Privacy Note -->
  <p style="margin-top: 1rem; font-size: 0.85rem;">
    By registering, you agree to BlinkTalk's 
    <a href="#" style="color: #cceeff; text-decoration: underline;">Terms of Service</a> 
    and 
    <a href="#" style="color: #cceeff; text-decoration: underline;">Privacy Policy</a>.
  </p>

  <!-- Already have an account? -->
  <p style="margin-top: 1rem; font-size: 0.9rem;">
    Already have an account?
    <a href="{{ url_for('login') }}" style="color: #cceeff; text-decoration: underline;">Login</a>
  </p>
</div>

<script>
// =========================
// 1. Show/Hide Toggles
// =========================
function togglePassword(inputId, btn) {
  const inputField = document.getElementById(inputId);
  if (inputField.type === "password") {
    inputField.type = "text";
    btn.textContent = "Hide";
  } else {
    inputField.type = "password";
    btn.textContent = "Show";
  }
}

// =========================
// 2. Custom Email Validation
// =========================
const emailInput = document.getElementById('email');
const emailError = document.getElementById('emailError');

emailInput.addEventListener('input', function() {
  const emailVal = emailInput.value.trim();
  if (emailVal !== "" && (!emailVal.includes('@') || !emailVal.includes('.'))) {
    emailError.style.display = 'block';
    emailError.textContent = "Please enter a valid email (e.g., user@example.com).";
  } else {
    emailError.style.display = 'none';
  }
});

// =========================
// 3. Username Live Validation & Availability Check
// =========================
const usernameInput = document.getElementById('username');
const usernameHint = document.getElementById('usernameHint');
const usernameExists = document.getElementById('usernameExists');

usernameInput.addEventListener('focus', function() {
  usernameHint.style.display = 'block';
});

usernameInput.addEventListener('input', function() {
  const username = usernameInput.value;
  const regex = /^[A-Za-z0-9_.]{2,32}$/;
  if (regex.test(username)) {
    usernameHint.style.color = '#aaffaa';
  } else {
    usernameHint.style.color = '#ffaaaa';
  }

  if (username.length > 1) {
    fetch("{{ url_for('check_username') }}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ username: username })
    })
    .then(response => response.json())
    .then(data => {
      if (data.exists) {
        usernameExists.style.display = 'block';
        usernameExists.textContent = "This username is already taken.";
      } else {
        usernameExists.style.display = 'none';
      }
    })
    .catch(error => {
      console.error("Error checking username:", error);
    });
  } else {
    usernameExists.style.display = 'none';
  }
});

// =========================
// 4. Password Strength Meter
// =========================
const passwordInput = document.getElementById('password');
const passwordMeter = document.getElementById('passwordMeter');
const passwordStrengthText = document.getElementById('passwordStrengthText');
const passwordStrengthContainer = document.getElementById('passwordStrengthContainer');

passwordInput.addEventListener('focus', function() {
  passwordStrengthContainer.style.display = 'block';
});

passwordInput.addEventListener('input', function() {
  const pwd = passwordInput.value;
  let strength = 0;
  if (pwd.length >= 6)  strength += 20;
  if (pwd.length >= 10) strength += 20;
  if (/[A-Z]/.test(pwd)) strength += 20;
  if (/[0-9]/.test(pwd)) strength += 20;
  if (/[\W_]/.test(pwd)) strength += 20;
  passwordMeter.value = strength;
  let color;
  if (strength < 40) {
    passwordStrengthText.textContent = "Weak";
    passwordStrengthText.style.color = "#ff4444";
    color = "#ff4444";
  } else if (strength < 80) {
    passwordStrengthText.textContent = "Moderate";
    passwordStrengthText.style.color = "#ffbb33";
    color = "#ffbb33";
  } else {
    passwordStrengthText.textContent = "Strong";
    passwordStrengthText.style.color = "#00C851";
    color = "#00C851";
  }
  passwordMeter.style.setProperty('--strength-color', color);
});

// =========================
// 5. Real-time Confirm Password Mismatch
// =========================
const confirmInput = document.getElementById('confirm');
const confirmError = document.getElementById('confirmError');

function checkPasswordsMatch() {
  if (confirmInput.value && passwordInput.value !== confirmInput.value) {
    confirmError.style.display = 'block';
    confirmError.textContent = "Passwords do not match.";
  } else {
    confirmError.style.display = 'none';
  }
}
confirmInput.addEventListener('input', checkPasswordsMatch);
passwordInput.addEventListener('input', checkPasswordsMatch);

// =========================
// 6. Dynamic Days in the Month
// =========================
const monthSelect = document.getElementById('month');
const daySelect = document.getElementById('day');
const yearSelect = document.getElementById('year');

// Populate the year dropdown from current year down to currentYear - 150
const currentYear = new Date().getFullYear();
for (let y = currentYear; y >= currentYear - 150; y--) {
  const option = document.createElement('option');
  option.value = y;
  option.textContent = y;
  yearSelect.appendChild(option);
}

// Helper: Check if leap year
function isLeapYear(y) {
  return ((y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0));
}

// Helper: Days in month
function getDaysInMonth(m, y) {
  if (!m || !y) return 31;
  if (m === 2) {
    return isLeapYear(y) ? 29 : 28;
  } else if ([4, 6, 9, 11].includes(m)) {
    return 30;
  } else {
    return 31;
  }
}

// Update days whenever month or year changes
function updateDays() {
  const m = parseInt(monthSelect.value);
  const y = parseInt(yearSelect.value);
  daySelect.innerHTML = '<option value="" disabled selected>Day</option>';
  const totalDays = getDaysInMonth(m, y);
  for (let d = 1; d <= totalDays; d++) {
    const option = document.createElement('option');
    option.value = d;
    option.textContent = d;
    daySelect.appendChild(option);
  }
}

monthSelect.addEventListener('change', updateDays);
yearSelect.addEventListener('change', updateDays);
</script>
{% endblock %}
